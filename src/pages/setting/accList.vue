<template>
    <div class="acc-list-wrapper">
        <div class="small-title">{{ $t('setting.setDefault') }}</div>
        <div class="acc-list __pointer">
            <div ref="listWrapper" class="list-wrapper">
                <div ref="list">
                    <div class="acc-item"
                         v-for="(addrObj, index) in addrList" :key="index"
                         @click="setDefault(addrObj.addr, index)" >
                        <span class="select" :class="{
                            'active': defaultAddr === addrObj.addr
                        }"></span>
                        <div class="describe __ellipsis">
                            <div v-show="showNameInput !== index" class="bold">
                                {{ addrObj.name || `${$t('addrName', { index:index + 1 })}`  }}
                            </div>
                            <form class="name-input" autocomplete="off">
                                <input ref="nameInput" type="text" autocomplete="off"
                                       v-show="showNameInput === index"
                                       v-model="editName"
                                       :placeholder="index"
                                       @blur="rename"/>
                            </form>
                            <div class="__ellipsis">{{ addrObj.addr }}</div>
                        </div>
                        <img @click.stop="startRename(addrObj.addr, index)" class="icon __pointer" :class="{
                            'not-allowed': !isWalletAcc
                        }" src="../../assets/imgs/edit_default.svg"/>
                        <img @click.stop="copy(addrObj.addr)" class="icon __pointer" src="../../assets/imgs/copy_default.svg"/>
                    </div>
                </div>
            </div>

            <div v-show="isWalletAcc && addrList.length < 10" class="add" @click="addAddr">
                <span class="acc-add"></span><span class="describe bold">{{ $t('setting.addAddr') }}</span>
            </div>
        </div>
    </div>
</template>

<script>
import Vue from 'vue';
import copy from 'utils/copy';

export default {
    data() {
        const activeAccount = this.$wallet.getActiveAccount();

        return {
            isWalletAcc: activeAccount.type === 'wallet',
            showNameInput: '',
            editName: ''
        };
    },
    computed: {
        defaultAddr() {
            return this.$store.state.activeAccount.address;
        },
        addrList() {
            return this.$store.state.activeAccount.addrList;
        }
    },
    watch: {
        addrList: function (val, oldVal) {
            if (val.length <= oldVal.length || val.length - oldVal.length > 1) {
                return;
            }

            Vue.nextTick(() => {
                if (!this.$refs.list || !this.$refs.listWrapper) {
                    return;
                }

                const height = this.$refs.list.offsetHeight;
                const wrapperHeight = this.$refs.listWrapper.offsetHeight;
                this.$refs.listWrapper.scrollTop = height - wrapperHeight;
            });
        }
    },
    methods: {
        copy(addr) {
            copy(addr);
            this.$toast(this.$t('hint.copy'));
        },
        addAddr() {
            this.$store.commit('activeAccAddAddr');
        },
        setDefault(address, index) {
            this.$store.dispatch('changeDefaultAddress', { address, index });
        },

        startRename(addr, index) {
            if (!this.isWalletAcc || this.showNameInput === index) {
                return;
            }

            this.showNameInput = index;
            Vue.nextTick(() => {
                this.$onKeyDown(13, () => {
                    this.rename(addr, index);
                });
                console.log(this.$refs.nameInput[index]);
                this.$refs.nameInput[index].focus();
            });
        },
        rename(addr, index) {
            if (!this.editName) {
                this.clearEditName();
                return;
            }

            const editName = this.editName.trim();

            if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/g.test(editName)) {
                this.$toast(this.$t('startCreate.hint.name'), 'error');
                this.clearEditName();
                return;
            }

            if (editName.length > 26) {
                this.$toast(this.$t('startCreate.hint.nameLong'), 'error');
                this.clearEditName();
                return;
            }

            this.$store.commit('activeAccSetAddrName', {
                addr,
                index,
                name: this.editName
            });
            this.clearEditName();
        },
        clearEditName() {
            this.showNameInput = '';
            this.editName = '';
            this.$offKeyDown();
        }
    }
};
</script>

<style lang="scss" scoped>
@import "~assets/scss/vars.scss";
@import "./setting.scss";

.acc-list {
    background: #fff;
    border: 1px solid #d4dee7;
    border-radius: 2px;
    font-size: 12px;

    .list-wrapper {
        max-height: 190px;
        overflow: auto;
    }

    .bold {
        font-family: $font-bold, arial, sans-serif;
        font-weight: 600;
    }
    .normal {
        font-weight: 400;
    }

    .acc-item {
        line-height: 20px;
        position: relative;
        padding: 10px 15px;
        border-bottom: 1px solid #d4dee7;
        display: flex;
        align-items: center;
        &:last-child {
            border: none;
        }
        .icon {
            margin-left: 12px;
            &.not-allowed {
                cursor: not-allowed;
            }
        }
    }

    .add {
        padding: 0 15px;
        height: 36px;
        line-height: 36px;
        font-size: 12px;
        color: #007aff;
        border-top: 1px solid #d4dee7;

        .acc-add {
            display: inline-block;
            margin: 10px 10px 0 0;
            width: 16px;
            height: 16px;
            background: url('../../assets/imgs/add_icon.svg') no-repeat center;
            background-size: 16px 16px;
        }

        .describe {
            display: inline;
            position: relative;
            bottom: 3px;
            color: #007aff;
        }
    }

    .describe {
        display: block;
        width: 93%;
        color: rgba(94,104,117,1);
        .name-input {
            display: block;
            width: 100%;
            input {
                display: block;
                width: 100%;
            }
        }
    }

    .select {
        margin: 2px 10px 0 0;
        display: block;
        box-sizing: border-box;
        width: 16px;
        height: 16px;
        background: #fff;
        border: 1px solid #d4dee7;
        border-radius: 16px;

        &.active {
            background: url('../../assets/imgs/presnet.svg') no-repeat center;
            background-size: 16px 16px;
        }
    }
}

@media only screen and (max-width: 500px) {
    .acc-list .list-wrapper {
        max-height: unset;
    }

    .acc-list .acc-item {
        padding: 10px;
    }

    .acc-list .add {
        padding: 0 10px;
    }
}
</style>
